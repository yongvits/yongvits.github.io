<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>AR Tracker + Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- A-Frame & MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    #ar-scene {
      width: 100vw;
      height: 100vh;
    }

    .ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
    }

    button {
      padding: 10px 16px;
      margin-right: 8px;
      font-size: 16px;
    }

    video#preview {
      display: none;
      position: absolute;
      bottom: 10px;
      left: 10px;
      max-width: 200px;
      z-index: 999;
      border: 2px solid white;
    }

    a#convertMP4 {
      display: none;
      position: absolute;
      bottom: 10px;
      left: 220px;
      font-size: 14px;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      z-index: 999;
      text-decoration: none;
      color: black;
    }
  </style>
</head>

<body>
  <!-- UI ‡∏õ‡∏∏‡πà‡∏° -->
  <div class="ui">
    <button id="startRecord">üé¨ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="stopRecord" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>

  <!-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ -->
  <video id="preview" controls></video>
  <a id="convertMP4" href="https://cloudconvert.com/webm-to-mp4" target="_blank">
    üëâ ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô MP4
  </a>

  <!-- AR Scene -->
  <a-scene
    mindar-image="imageTargetSrc: Targets.mind"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    embedded
    id="ar-scene"
  >
    <a-assets>
      <a-asset-item id="model" src="AR.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏° smooth -->
    <a-entity mindar-image-target="targetIndex: 0" 
              smooth="true" 
              smoothCount="10" 
              smoothTolerance="0.01" 
              smoothThreshold="5">
      <a-gltf-model
        src="#model"
        position="0 0 0"
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
      ></a-gltf-model>
    </a-entity>
  </a-scene>

  <!-- JS: Record video -->
  <script>
    let recorder;
    let recordedChunks = [];

    const startBtn = document.getElementById("startRecord");
    const stopBtn = document.getElementById("stopRecord");
    const preview = document.getElementById("preview");
    const convertLink = document.getElementById("convertMP4");

    startBtn.onclick = async () => {
      const canvas = document.querySelector("canvas");

      if (!canvas.captureStream) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠");
        return;
      }

      const stream = canvas.captureStream(30);
      recorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      recordedChunks = [];
      recorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      recorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        preview.src = url;
        preview.style.display = "block";

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const a = document.createElement("a");
        a.href = url;
        a.download = "ar-recording.webm";
        a.click();

        convertLink.style.display = "inline-block";
      };

      recorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      recorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>
