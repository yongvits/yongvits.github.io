<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>AR Image Tracking with Recording</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- A-Frame ‡πÅ‡∏•‡∏∞ MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    #ar-scene {
      width: 100vw;
      height: 100vh;
    }

    .ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
    }

    button {
      padding: 10px 16px;
      margin-right: 8px;
      font-size: 16px;
    }

    video#preview {
      display: none;
      position: absolute;
      bottom: 10px;
      left: 10px;
      max-width: 200px;
      z-index: 999;
      border: 2px solid white;
    }
  </style>
</head>

<body>
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
  <div class="ui">
    <button id="startRecord">üî¥ REC</button>
    <button id="stopRecord" disabled>‚èπÔ∏è STOP</button>
  </div>

  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à -->
  <video id="preview" controls></video>

  <!-- AR Scene -->
  <a-scene
    mindar-image="imageTargetSrc: Targets.mind"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    embedded
    id="ar-scene"
  >
    <!-- ‡πÇ‡∏´‡∏•‡∏î asset ‡πÇ‡∏°‡πÄ‡∏î‡∏• -->
    <a-assets>
      <a-asset-item id="model" src="AR.glb"></a-asset-item>
    </a-assets>

    <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-gltf-model
        src="#model"
        position="0 0 0"
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
      ></a-gltf-model>
    </a-entity>
  </a-scene>

  <!-- JS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ -->
  <script>
    let recorder;
    let recordedChunks = [];

    const startBtn = document.getElementById("startRecord");
    const stopBtn = document.getElementById("stopRecord");
    const preview = document.getElementById("preview");

    startBtn.onclick = async () => {
      const canvas = document.querySelector("canvas");

      if (!canvas.captureStream) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠");
        return;
      }

      const stream = canvas.captureStream(30); // 30 fps
      recorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      recordedChunks = [];
      recorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      recorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        preview.src = url;
        preview.style.display = "block";

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const a = document.createElement("a");
        a.href = url;
        a.download = "ar-recording.webm";
        a.click();
      };

      recorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      recorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>